## Введение или как все начиналось ##
Мне надоело каждый раз после проведения почтовой рассылки клиентам выискивать адреса во все возможных черных списках (DNSBL). В результате родился этот скрипт. Первая версия работала через http путем парсинга html страниц. В базе скрипта было всего 9 черных списков (самых частых из мне встречающихся). После публикации скрипта в блоге и на линсовете, я задумался о том, чтобы расширить кол-во известных скрипту черных списков и научить его работать напрямую с DNSBL. В результате на свет появилась вторая версия скрипта. Но меня не устраивала скорость его работы и отсутствие некоторой гибкости. Поэтому было принято решение переписать скрипт с нуля с учетом этих нюансов. И появился spam-check 0.3.

На сегодняшний день мне в разработке помогает товарищ [\_GaSh\_](http://linsovet.com/users/gash).



## Для чего... ##
Скрипт spam-check предназначен для облегчения и автоматизации проверки своих серверов на наличие оных в черных списках.



## Как это работает... ##
Скрипт принимает FQDN и IP адреса. Все FQDN адреса переводятся в IP адреса. Потом берется первый адрес, из переданных скрипту, и проверяется по базе черных списков (DNSBL). Результат проверки скрипт выводит на консоль. Все удачные проверки, т.е. если проверяемого адреса нет в черном списке, выводятся на стандартный поток вывода (stdout), а не удачные, когда проверяемый адрес присутствует в черном списке, -- на стандартный поток ошибок (stderr). Если хоть один адрес присутствует хоть в одном черном списке, то код завершения будет 1, иначе 0. Если вы решите запускать скрипт по расписанию, например, через cron, то используйте ключ "-q", чтобы подавить весь вывод на консоль.

По умолчанию скрипт использует внутреннюю базу, состоящую из 117 черных списков. Вы так же можете указать внешнюю базу (ключ "-f"), тогда скрипт проигнорирует внутреннюю базу и будет использовать внешнюю. Внешняя база представляет из себя простой текстовый файл, в котором перечислены все базы, по одной на строку либо разделенных пробелами. Если же вы хотите использовать одновременно и внутреннюю и внешнюю базы, то укажите знак "+" (плюс) перед именем файл после ключа "-f", например:
```
$ spam-check -f +~/my_db.txt example.org
```
Помимо этого скрипт может сам скачать и использовать базу с сайта [http://myiptest.com/](http://myiptest.com/) (но ПОКА не умеет ее объединять с внутренней и/или вашей внешней базой), для этого предназначен ключ "-i".

Скрипт проверяет наличие и права на чтение файла /etc/resolv.conf, считывает указанные в нем адреса DNS-северов и использует первый доступный. Если же файла нет или нет прав на чтение, или в нем нет ни одной строки начинающейся на "nameserver", или ни один из перечисленных в нем DNS-серверов не доступен, то используется DNS-сервер по умолчанию, который указан в переменной $DNS\_SERVER, -- первичный сервер [OpenDNS.com](http://opendns.com/). Вы так же можете использовать любой другой DNS-сервер, посредством ключа "-s".

Если вам понадобится проверить адрес по какому-то определенному черному списку, то используйте ключ "-d".

Так же могут быть полезными ключи "-l" и "-p". Первый выводит все черные списки, которые будут использованы скриптом, а второй - ip-адреса, которые будут проверены. При этом сама проверка не выполняется.

Порядок указания IP и/или FQDN значения не имеет. Если указать ключ "--", то после него должны идти только IP и/или FQDN.



## Особенности и фичи ##
Когда скрипт преобразовывает FQDN в IP, то он так же учитывает MX-записи. Если на запрос MX'а DNS-сервер возвращает другой MX, то скрипт это так же учитывает и в цикле проверяет все MX'ы. Такая проверка, теоретически, может привести к бесконечному циклу, хоть это и мало вероятно.
